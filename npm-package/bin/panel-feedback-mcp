#!/usr/bin/env node
/**
 * Global npm executable for panel-feedback MCP server
 * 使用轮询机制等待用户反馈，支持长时间等待
 */

const http = require('http');
const readline = require('readline');
const crypto = require('crypto');

const SERVER_PORT = 19876;
const POLL_INTERVAL = 500;  // 500ms 轮询间隔
const MAX_POLL_TIME = 86400000 * 7;  // 最长等待 7 天

const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
    terminal: false
});

// 生成唯一请求 ID
function generateRequestId() {
    return crypto.randomUUID();
}

// 休眠函数
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// 发送 HTTP 请求
function sendRequest(path, data) {
    return new Promise((resolve, reject) => {
        const postData = JSON.stringify(data);
        const options = {
            hostname: '127.0.0.1',
            port: SERVER_PORT,
            path: path,
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(postData)
            },
            timeout: 5000  // 短超时，快速失败
        };

        const req = http.request(options, (res) => {
            let body = '';
            res.on('data', chunk => body += chunk);
            res.on('end', () => {
                try {
                    resolve(JSON.parse(body));
                } catch (e) {
                    reject(new Error('Invalid JSON response'));
                }
            });
        });

        req.on('error', (e) => {
            if (e.code === 'ECONNREFUSED') {
                // 服务器未启动，返回特殊标记
                resolve({ _connectionRefused: true });
            } else {
                reject(e);
            }
        });

        req.on('timeout', () => {
            req.destroy();
            reject(new Error('Request timeout'));
        });

        req.write(postData);
        req.end();
    });
}

// 轮询获取结果
async function pollForResult(requestId) {
    const startTime = Date.now();
    let connectionRefusedCount = 0;
    
    while (Date.now() - startTime < MAX_POLL_TIME) {
        try {
            const result = await sendRequest('/poll', { requestId });
            
            // 检查连接被拒绝
            if (result._connectionRefused) {
                connectionRefusedCount++;
                // 连续多次连接失败才报错
                if (connectionRefusedCount > 10) {
                    throw new Error('Panel Feedback extension not started. Please open the AI Feedback panel in VS Code/Windsurf first.');
                }
            } else {
                connectionRefusedCount = 0;  // 重置计数
                
                if (result.status === 'completed') {
                    return result.data;
                } else if (result.status === 'error') {
                    throw new Error(result.error || 'Unknown error');
                }
                // status === 'pending'，继续轮询
            }
        } catch (err) {
            // 非连接拒绝的错误，记录但继续轮询
            if (!err.message.includes('Panel Feedback extension not started')) {
                process.stderr.write(`Poll error: ${err.message}\n`);
            } else {
                throw err;  // 连接拒绝太多次，抛出错误
            }
        }
        
        await sleep(POLL_INTERVAL);
    }
    
    throw new Error('Poll timeout after 7 days');
}

// 处理 tools/call 请求（使用轮询）
async function handleToolCall(mcpId, params) {
    const requestId = generateRequestId();
    
    // 1. 提交请求（快速返回）
    const submitResult = await sendRequest('/submit', {
        requestId,
        params
    });
    
    if (submitResult._connectionRefused) {
        return {
            jsonrpc: '2.0',
            id: mcpId,
            error: {
                code: -32000,
                message: 'Panel Feedback extension not started. Please open the AI Feedback panel in VS Code/Windsurf first.'
            }
        };
    }
    
    if (submitResult.error) {
        return {
            jsonrpc: '2.0',
            id: mcpId,
            error: { code: -32000, message: submitResult.error }
        };
    }
    
    // 2. 轮询等待结果
    try {
        const result = await pollForResult(requestId);
        return {
            jsonrpc: '2.0',
            id: mcpId,
            result
        };
    } catch (err) {
        return {
            jsonrpc: '2.0',
            id: mcpId,
            error: { code: -32000, message: err.message }
        };
    }
}

// 处理其他 MCP 请求（直接转发）
async function handleOtherRequest(request) {
    const result = await sendRequest('/', request);
    
    if (result._connectionRefused) {
        return {
            jsonrpc: '2.0',
            id: request.id,
            error: {
                code: -32000,
                message: 'Panel Feedback extension not started. Please open the AI Feedback panel in VS Code/Windsurf first.'
            }
        };
    }
    
    return result;
}

function respond(response) {
    console.log(JSON.stringify(response));
}

// 处理标准输入
rl.on('line', async (line) => {
    try {
        const request = JSON.parse(line);
        const { id, method, params } = request;
        
        let response;
        
        // tools/call 请求使用轮询机制
        if (method === 'tools/call' && params?.name === 'panel_feedback') {
            response = await handleToolCall(id, params);
        } else {
            // 其他请求直接转发
            response = await handleOtherRequest(request);
        }
        
        respond(response);
        
    } catch (err) {
        respond({
            jsonrpc: '2.0',
            id: null,
            error: { code: -32700, message: 'Parse error: ' + err.message }
        });
    }
});

// 启动时输出就绪信息
process.stderr.write('panel-feedback-mcp server started (polling mode)\n');
